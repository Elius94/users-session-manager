# users-session-manager
A simple Node.js module to manage users sessions on a web application or any kind of JS apps
It uses a Singleton pattern to ensure that only one instance of the module is running at a time.
SessionManager is a singleton class that can be used to manage users sessions.
For every user that logs in, a new session is created and stored in the database.
Every session has a unique ID that is generated by the system.
Every session has a setTimeout that expires after a certain time (setSessionTimeout).
When a user logs out, the session is deleted from the class.
Every action fires an event that can be used to listen to the session manager.

## Installation

Install with:
```sh
npm i users-session-manager
```

Example of usage:
```js
// Import module with ES6 syntax
import { SessionManager } from '../index.js';

// Create a new instance of the SessionManager class
const SM = new SessionManager();

// Change session Expiration time:
SM.setSessionTimeOut(6)

// Call this to initialize a new user session
SM.loadNewSession("Luca")
SM.loadNewSession("Fabio")

// You can listen to events emitted from this library through eventEmitter object exported
SM.on("activeUserDeleted", (key) => {
    console.log(`User ${key} has been deleted`)
})

setInterval(() => {
    console.log(SM.getLoggedUsers())
}, 5000)
```

## Integrate with Socket.io server to notify clients

```js
// Import module with ES6 syntax
import { SessionManager } from '../index.js';

const http = require('http')

// Create a new instance of the SessionManager class
const SM = new SessionManager();

/**
 * Create and start an ioSocket server
 * @param {*} app
 * "Express" handle
 * @param {*} port
 * Port the server should listen on
 * @returns {SocketIO.Server}
 * The newly created server
 */
 function startServer(app, port) {
    // Create an http server
    const server = http.createServer(app)
    server.listen(port)
    server.on('error', function(error) { onError(error, port) })
    server.on('listening', function() { onListening(server) })

    // Create the socketIO server
    const ENDPOINT = `localhost:3000`;
    const { Server } = require("socket.io");
    const io = new Server(server, {
        cors: {
            origin: ENDPOINT,
            methods: ["GET", "POST"]
        }
    });

    io.on('connection', (sk) => {
        console.log('Browser Connected!')
        sk.on('session_key', async function(data) {
            const key = data.session_key
            console.log(`User ${data.user} joined key ${key}`)
            sk.join(key)
        })
    })

    return io
}

SM.initSocketReferences(startServer(app, port)) // Initialize the socket references

SM.on("notifyClientToLogout", (io, key) => { // When a user logs out, notify the client
    console.debug(`Session is expired for key ${key}... Logging out now!`)
    io.in(key).emit('logout') // Emit the logout event to the client
})
```

## Exported APIs

 - ```eventEmitter```:
    Node.js Event Emitter object, is extended by the class. It fires the following events:
    - 'error': Called when some error happens (eg: Session is rejected)
    - 'sessionDeleted': Called when a session is deleted or if expired
    - 'sessionCreated': Called when a user session is created
    - 'notifyClientToLogout': Called when a session timer is expired, bind this to a Socket.io server to force clients to logout

## Integrate with metrics tools like PM2

```js
const io = require('@pm2/io') // Initialize the pm2 io module

// The PM2 IO metrics to monitor the number of connected users
const realtimeUser = io.counter({
    name: 'Realtime Users',
    id: 'app/realtime/users',
})

SM.on("sessionCreated", (key) => { // When a user logs out, notify the client
    realtimeUser.inc() // Increment the number of active users
})

SM.on("sessionDeleted", (key) => { // When a user logs out, notify the client
    realtimeUser.dec() // Decrement the number of active users
})
```

## Classes

<dl>
<dt><a href="#SessionManager">SessionManager</a> ⇐ <code>EventEmitter</code></dt>
<dd><p>SessionManager is a class that manages the sessions of the users.</p>
</dd>
</dl>

## Constants

<dl>
<dt><a href="#sessions">sessions</a> : <code>Object</code></dt>
<dd><p>The sessions of the users.</p>
</dd>
<dt><a href="#MIN_SESSION_TIMEOUT">MIN_SESSION_TIMEOUT</a> : <code>number</code></dt>
<dd><p>The minimum session timeout.</p>
</dd>
<dt><a href="#settings">settings</a> : <code>Object</code></dt>
<dd><p>The settings of the session manager.</p>
</dd>
</dl>

## Functions

<dl>
<dt><a href="#log">log(msg)</a> ⇒ <code>void</code></dt>
<dd><p>Logs a message to the console if the debug flag is set to true in the config.</p>
</dd>
</dl>

<a name="SessionManager"></a>

## SessionManager ⇐ <code>EventEmitter</code>
SessionManager is a class that manages the sessions of the users.

**Kind**: global class
**Extends**: <code>EventEmitter</code>

* [SessionManager](#SessionManager) ⇐ <code>EventEmitter</code>
    * [.setSessionTimeOut(sessionTimeout)](#SessionManager+setSessionTimeOut) ⇒ <code>boolean</code>
    * [.getSessionTimeout()](#SessionManager+getSessionTimeout) ⇒ <code>number</code>
    * [.getLoggedUsers()](#SessionManager+getLoggedUsers) ⇒ <code>array</code>
    * [.initSocketReference(ioRef)](#SessionManager+initSocketReference) ⇒ <code>boolean</code>
    * [.getSocketReference()](#SessionManager+getSocketReference) ⇒ <code>SocketIO.Server</code>
    * [.loadNewSession(username)](#SessionManager+loadNewSession) ⇒ <code>string</code>
    * [.deleteSession(key)](#SessionManager+deleteSession) ⇒ <code>boolean</code>
    * [.deleteAllSessions()](#SessionManager+deleteAllSessions) ⇒ <code>boolean</code>
    * [.sendLogoutMessage(key)](#SessionManager+sendLogoutMessage) ⇒ <code>boolean</code>
    * [.createNewSessionTimer(key, username)](#SessionManager+createNewSessionTimer) ⇒ <code>NodeJS.Timeout</code>
    * [.checkSessionStatus(key)](#SessionManager+checkSessionStatus) ⇒ <code>boolean</code>
    * [.getUsernameFromSessionKey(key)](#SessionManager+getUsernameFromSessionKey) ⇒ <code>string</code>

<a name="SessionManager+setSessionTimeOut"></a>

### sessionManager.setSessionTimeOut(sessionTimeout) ⇒ <code>boolean</code>
This function is used to set the session timeout

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>boolean</code> - true or false: true if ok

| Param | Type | Description |
| --- | --- | --- |
| sessionTimeout | <code>number</code> | The session timeout in seconds |

**Example**
```js
setSessionTimeOut(3000) // Returns true or false
```
<a name="SessionManager+getSessionTimeout"></a>

### sessionManager.getSessionTimeout() ⇒ <code>number</code>
This function is used to get the session timeout

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>number</code> - The session timeout in seconds
**Example**
```js
getSessionTimeOut() // Returns 3000
```
<a name="SessionManager+getLoggedUsers"></a>

### sessionManager.getLoggedUsers() ⇒ <code>array</code>
This function is used to get the list of logged users

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>array</code> - The list of logged users
**Example**
```js
getLoggedUsers() // Returns ['Gino', 'Gino2']
```
<a name="SessionManager+initSocketReference"></a>

### sessionManager.initSocketReference(ioRef) ⇒ <code>boolean</code>
Function to copy the Socket IO http server reference

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>boolean</code> - true or false, true if ok

| Param | Type |
| --- | --- |
| ioRef | <code>\*</code> |

<a name="SessionManager+getSocketReference"></a>

### sessionManager.getSocketReference() ⇒ <code>SocketIO.Server</code>
Function to get the socket reference

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>SocketIO.Server</code> - The socket reference
<a name="SessionManager+loadNewSession"></a>

### sessionManager.loadNewSession(username) ⇒ <code>string</code>
Function to add users sessions in this module. Use it at login

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>string</code> - user unique key

| Param | Type | Description |
| --- | --- | --- |
| username | <code>string</code> | The username provided on successful login |

**Example**
```js
addSession('Gino') // Returns 'session_key'
```
<a name="SessionManager+deleteSession"></a>

### sessionManager.deleteSession(key) ⇒ <code>boolean</code>
Function to delete users sessions in this module. Use it at client logout

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>boolean</code> - true or false, true if ok
**Throws**:

- <code>Error</code> If the session_key is not found


| Param | Type | Description |
| --- | --- | --- |
| key | <code>string</code> | The session_key provided on successful login |

**Example**
```js
deleteSession('session_key') // Returns true or false
```
<a name="SessionManager+deleteAllSessions"></a>

### sessionManager.deleteAllSessions() ⇒ <code>boolean</code>
Function to delete all sessions

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>boolean</code> - true or false, true if ok
<a name="SessionManager+sendLogoutMessage"></a>

### sessionManager.sendLogoutMessage(key) ⇒ <code>boolean</code>
Use this to notify the client to logout with WebSocket

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>boolean</code> - true or false, true if ok

| Param | Type | Description |
| --- | --- | --- |
| key | <code>string</code> | The session_key |

**Example**
```js
sendLogoutMessage('session_key') // Returns true or false
```
<a name="SessionManager+createNewSessionTimer"></a>

### sessionManager.createNewSessionTimer(key, username) ⇒ <code>NodeJS.Timeout</code>
Function to return a new setTimeout object and start it.

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)

| Param | Type | Description |
| --- | --- | --- |
| key | <code>string</code> | The session_key |
| username | <code>string</code> | The username, only for logging features |

**Example**
```js
createNewSessionTimer('session_key', 'username') // Returns a new setTimeout object
```
<a name="SessionManager+checkSessionStatus"></a>

### sessionManager.checkSessionStatus(key) ⇒ <code>boolean</code>
Use this before every API.js function execution.n the stored collection

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>boolean</code> - true or false: true if session is active
**Throws**:

- <code>Error</code> if the session is not valid
- <code>Error</code> if the session is expired


| Param | Type | Description |
| --- | --- | --- |
| key | <code>string</code> | the user key generated at login |

**Example**
```js
checkSessionStatus('my_session_key') // true or false
```
<a name="SessionManager+getUsernameFromSessionKey"></a>

### sessionManager.getUsernameFromSessionKey(key) ⇒ <code>string</code>
Function to get the username from a session key

**Kind**: instance method of [<code>SessionManager</code>](#SessionManager)
**Returns**: <code>string</code> - The username or false if not found

| Param | Type | Description |
| --- | --- | --- |
| key | <code>string</code> | The session key |

**Example**
```js
getUsernameFromSessionKey('123456789_123456789') // 'username'
```
<a name="sessions"></a>

## sessions : <code>Object</code>
The sessions of the users.

**Kind**: global constant
<a name="MIN_SESSION_TIMEOUT"></a>

## MIN\_SESSION\_TIMEOUT : <code>number</code>
The minimum session timeout.

**Kind**: global constant
<a name="settings"></a>

## settings : <code>Object</code>
The settings of the session manager.

**Kind**: global constant
<a name="log"></a>

## log(msg) ⇒ <code>void</code>
Logs a message to the console if the debug flag is set to true in the config.

**Kind**: global function

| Param | Type |
| --- | --- |
| msg | <code>string</code> |